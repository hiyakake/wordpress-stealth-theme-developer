# 運用中の WordPress サイトの改修が辛い問題をどうにかするツールを作った話

## はじめに

WordPress でサイトを制作・運用している方なら、一度は「本番環境の改修が怖い」と感じたことがあるのではないでしょうか。特に運用中のサイトでは、実データを使ったテストが必要なのに、本番環境をいじるとユーザーに影響が出るというジレンマがあります。

これまで私は次のような悩みを抱えていました：

- ローカル環境では本番と同じデータを再現できず、テストの信頼性が低い
- テスト環境を作っても、データ同期が煩雑で常に最新状態を保つのが難しい
- FTP でファイルをアップロードして確認する作業が面倒で時間がかかる
- 変更をアップロードする度にブラウザを手動でリロードする必要がある

このような問題を解決するために、**運用中の WordPress サイトを安全に改修できる開発環境**を構築するツールを作成しました。

## 問題：WordPress テーマ開発の難しさ

WordPress サイトの開発・改修で直面する主な問題は以下の通りです：

### 1. 環境の分離問題

- **ローカル環境**: データが本番と異なるため、実際のコンテンツでテストできない
- **テスト環境**: データ同期が必要で、常に最新を保つのが困難
- **本番環境**: 直接修正すると訪問者に影響が出る可能性がある

### 2. ワークフローの非効率さ

- ファイルを変更するたびに手動で FTP アップロード
- アップロード後にブラウザを手動でリロード
- 変更確認のサイクルが遅く、開発効率が落ちる

### 3. チーム開発の難しさ

- 環境構築の手順が複雑で再現性が低い
- 設定の共有が難しく、開発者ごとに環境が異なる

## 解決策：本番データを使いながら安全に開発できる環境

これらの問題を解決するために、次の特徴を持つ開発環境を構築しました：

1. **本番データをそのまま使用**: テスト用のデータ同期が不要
2. **訪問者には影響なし**: 開発者だけが新しいテーマを確認できる
3. **自動アップロード**: ファイル変更を検知して自動的にアップロード
4. **自動リロード**: ブラウザが自動的にリロードされる
5. **環境の再現性**: 設定を共有しやすく、誰でも同じ環境を構築可能

## 技術的な仕組み

このソリューションは、いくつかのオープンソースツールと独自のスクリプトを組み合わせて実現しています。

### 1. Theme Switcha プラグインの活用

[Theme Switcha](https://wordpress.org/plugins/theme-switcha/)という WordPress プラグインを利用します。このプラグインの特徴は：

- 管理者だけが特定のテーマを表示できる
- URL パラメータを使って特定のテーマを表示できる
- パスキーによる保護機能がある

これにより、一般訪問者には公開中のテーマを表示しながら、開発者だけが新しいテーマを確認できます。

### 2. 自動アップロードとブラウザリロード

次の npm パッケージを組み合わせて、開発者体験を向上させました：

- **chokidar**: ファイル変更を監視
- **ssh2-sftp-client**: SFTP でファイルを自動アップロード
- **browser-sync**: ブラウザの自動リロード
- **dotenv**: 環境変数による設定管理
- **inquirer**: 対話式セットアップウィザード

### 3. VS Code SFTP プラグインとの連携

[VS Code SFTP](https://marketplace.visualstudio.com/items?itemName=Natizyskunk.sftp)プラグインと連携し、初期ファイルのアップロードや一括アップロードを簡単に行えるようにしました。

## 実際の使い方

### セットアップ

```bash
# テンプレートから新しいプロジェクトを作成
cd template
./init.sh

# プロジェクト名を入力
# → 新しいプロジェクトディレクトリが作成される

# 新しいプロジェクトディレクトリに移動
cd プロジェクト名

# 依存パッケージのインストール
npm install

# セットアップウィザードの実行
npm run prepare
```

セットアップウィザードでは、以下の情報を入力します：

- WordPress サイトのホスト名
- SFTP 接続情報
- Theme Switcha プラグインの設定
- その他の開発環境設定

### 開発の開始

```bash
npm run dev
```

このコマンドを実行すると：

1. ブラウザが自動的に開き、開発中のテーマが表示される
2. `src`ディレクトリ内のファイルを編集すると、自動的にサーバーにアップロードされる
3. アップロード後、ブラウザが自動的にリロードされる

## 具体的なユースケース

### ケース 1: サイトデザインの大幅リニューアル

運用中のサイトをリニューアルする場合、通常は以下のような工程が必要です：

1. テスト環境の構築
2. データベースの同期
3. 新テーマの開発
4. 本番環境への反映

このツールを使えば：

1. 本番サイトに新テーマ用ディレクトリを作成
2. 開発環境を設定
3. 実データを使いながら新テーマを開発
4. 完成したら本番のテーマを切り替え

データ同期の手間がなく、常に最新のコンテンツでテストできます。

### ケース 2: 小規模な修正作業

ヘッダーデザインの変更や CSS の微調整など、小規模な修正の場合：

1. 修正するファイルを編集
2. 自動的にアップロードされ、ブラウザがリロード
3. すぐに変更結果を確認できる

手動でのアップロードやリロードが不要なため、作業効率が格段に向上します。

## 重要な注意事項：セキュリティと適用範囲

このツールを使用する前に、以下の点に注意してください：

### 適用範囲

- **一般的な WordPress サイト向け**: このツールは一般的な情報を扱う WordPress サイトの開発を対象としています
- **適していないケース**: 機密性の高い情報（個人情報、金融情報、医療情報など）を扱うサイトでの使用は推奨しません
- **リスク評価**: 使用前にサイトの性質とセキュリティ要件を評価し、適切かどうか判断してください

### セキュリティに関する免責事項

- **セキュリティの保証なし**: このツールはセキュリティを保証するものではありません
- **SSH/SFTP セキュリティ**: サーバー接続には安全な SSH/SFTP を使用していますが、鍵管理や接続設定は利用者の責任で行ってください
- **パスキー保護**: Theme Switcha のパスキー機能を使用していますが、これは完全なセキュリティ対策ではありません
- **実装の責任**: このツールの実装と使用に関する責任は利用者にあります

### 使用時の推奨事項

1. 機密性の低いサイトでのみ使用する
2. 強力なパスワードとパスキーを設定する
3. SSH キーを適切に管理する
4. 開発完了後は不要なテーマファイルを削除する
5. 本番環境では定期的にセキュリティチェックを行う

この開発ソリューションは開発効率を向上させるものであり、セキュリティツールではないことをご理解ください。セキュリティが最優先される環境では、完全に分離された開発環境の使用を検討してください。

## まとめ

このツールを使うことで得られるメリット：

1. **安全性**: 本番サイトに影響を与えずに開発可能
2. **効率性**: 自動アップロードとリロードで開発サイクルが高速化
3. **正確性**: 実データを使ったテストで、より正確な開発が可能
4. **再現性**: 環境設定が標準化され、チーム開発が容易に

WordPress サイトの開発・改修に悩んでいる方は、ぜひこのツールを試してみてください。
